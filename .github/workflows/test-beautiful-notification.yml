name: Test Beautiful Discord Notification

on:
  workflow_dispatch:

jobs:
  test-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Send Beautiful Test Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_UPM }}
          DISCORD_THREAD_ID: "1437635998509957181"
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "âŒ DISCORD_WEBHOOK_UPM secret not set"
            exit 1
          fi

          echo "ğŸ“¤ Sending beautiful test notification with sample package data..."

          # Create sample notification payload with all features
          jq -n \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{
              "embeds": [{
                "author": {
                  "name": "UPM Auto Publisher",
                  "icon_url": "https://raw.githubusercontent.com/github/explore/80688e429a7d4ef2fca1e82350fe8e3517d3494d/topics/npm/npm.png"
                },
                "title": "ğŸ“¦ Package Published Successfully",
                "description": "ğŸ¢ **Repository:** [`The1Studio/UITemplate`](https://github.com/The1Studio/UITemplate)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
                "color": 5763719,
                "fields": [
                  {
                    "name": "ğŸ“‹ Published Packages",
                    "value": "### ğŸš€ com.theone.core\nâ”£â” **Version:** `2.0.5` âœ `3.0.0`\nâ”£â” **Change Type:** ğŸ”´ **MAJOR**\nâ”—â” **Registry:** https://upm.the1studio.org/-/web/detail/com.theone.core\n\n### âœ¨ com.theone.ui\nâ”£â” **Version:** `1.2.3` âœ `1.3.0`\nâ”£â” **Change Type:** ğŸŸ¡ **MINOR**\nâ”—â” **Registry:** https://upm.the1studio.org/-/web/detail/com.theone.ui\n\n### ğŸ”§ com.theone.utils\nâ”£â” **Version:** `1.0.7` âœ `1.0.8`\nâ”£â” **Change Type:** ğŸŸ¢ **PATCH**\nâ”—â” **Registry:** https://upm.the1studio.org/-/web/detail/com.theone.utils\n\n### ğŸ†• com.theone.analytics\nâ”—â” **Version:** `1.0.0` _(new package)_\nâ”—â” **Registry:** https://upm.the1studio.org/-/web/detail/com.theone.analytics",
                    "inline": false
                  },
                  {
                    "name": "ğŸ“Š Publishing Summary",
                    "value": "âœ… **Published:** 4 package(s)\nâ­ï¸  **5 packages skipped** (already published)",
                    "inline": false
                  },
                  {
                    "name": "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
                    "value": "",
                    "inline": false
                  },
                  {
                    "name": "ğŸ’¬ Commit Details",
                    "value": "[`a1b2c3d`](https://github.com/The1Studio/UITemplate/commit/a1b2c3d) feat: upgrade packages with breaking changes ğŸš€\nğŸ‘¤ **Author:** tuha263",
                    "inline": false
                  },
                  {
                    "name": "ğŸ”— Links",
                    "value": "ğŸ“‹ [Workflow Run](https://github.com/The1Studio/UPMAutoPublisher/actions/runs/${{ github.run_id }})\nğŸ“¦ [Registry](https://upm.the1studio.org)",
                    "inline": false
                  }
                ],
                "thumbnail": {
                  "url": "https://raw.githubusercontent.com/github/explore/80688e429a7d4ef2fca1e82350fe8e3517d3494d/topics/unity/unity.png"
                },
                "timestamp": $timestamp,
                "footer": {
                  "text": "UPM Auto Publisher â€¢ The1Studio â€¢ TEST DEMO",
                  "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                }
              }]
            }' > discord_payload.json

          # Send to Discord thread
          curl -X POST "$DISCORD_WEBHOOK?thread_id=$DISCORD_THREAD_ID" \
            -H "Content-Type: application/json" \
            -d @discord_payload.json \
            --fail --silent --show-error

          if [ $? -eq 0 ]; then
            echo "âœ… Beautiful test notification sent successfully!"
            echo ""
            echo "ğŸ“‹ Sample includes:"
            echo "  ğŸ”´ MAJOR upgrade (3.0.0) - Breaking changes"
            echo "  ğŸŸ¡ MINOR upgrade (1.3.0) - New features"
            echo "  ğŸŸ¢ PATCH upgrade (1.0.8) - Bug fixes"
            echo "  ğŸ†• NEW package (1.0.0) - First release"
          else
            echo "âŒ Failed to send notification"
            exit 1
          fi

          rm -f discord_payload.json
