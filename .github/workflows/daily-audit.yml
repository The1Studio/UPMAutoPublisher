name: Daily Repository Audit

on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 9 AM UTC

  workflow_dispatch:  # Manual trigger

permissions:
  contents: read

jobs:
  audit:
    runs-on: [self-hosted, arc, the1studio, org]
    timeout-minutes: 15
    name: Comprehensive repository health check
    outputs:
      total_repos: ${{ steps.stats.outputs.total_repos }}
      active: ${{ steps.stats.outputs.active }}
      pending: ${{ steps.stats.outputs.pending }}
      disabled: ${{ steps.stats.outputs.disabled }}
      total_pkgs: ${{ steps.stats.outputs.total_pkgs }}
      uptodate: ${{ steps.stats.outputs.uptodate }}
      stale: ${{ steps.stats.outputs.stale }}
      new: ${{ steps.stats.outputs.new }}
      cache_exists: ${{ steps.stats.outputs.cache_exists }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install dependencies
        run: |
          # Fix APT sources to use HTTPS instead of HTTP (port 80 blocked)
          sudo sed -i 's|http://archive.ubuntu.com|https://archive.ubuntu.com|g' /etc/apt/sources.list
          sudo sed -i 's|http://security.ubuntu.com|https://security.ubuntu.com|g' /etc/apt/sources.list

          # Disable PPA repositories
          sudo mv /etc/apt/sources.list.d /etc/apt/sources.list.d.bak 2>/dev/null || true
          sudo mkdir -p /etc/apt/sources.list.d

          sudo apt-get update
          sudo apt-get install -y jq

          # Install GitHub CLI
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Run comprehensive audit
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          ./scripts/audit-repos.sh

      - name: Create audit report
        if: always()
        run: |
          echo "# üîç Daily Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +%Y-%m-%d\ %H:%M:%S)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Repository status
          total=$(jq '.repositories | length' config/repositories.json)
          active=$(jq '[.repositories[] | select(.status == "active")] | length' config/repositories.json)
          pending=$(jq '[.repositories[] | select(.status == "pending")] | length' config/repositories.json)
          disabled=$(jq '[.repositories[] | select(.status == "disabled")] | length' config/repositories.json)

          echo "## üìä Repository Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total**: $total" >> $GITHUB_STEP_SUMMARY
          echo "- **Active**: $active" >> $GITHUB_STEP_SUMMARY
          echo "- **Pending**: $pending" >> $GITHUB_STEP_SUMMARY
          echo "- **Disabled**: $disabled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Package status (if cache exists)
          if [ -f config/package-cache.json ]; then
            echo "## üì¶ Package Status" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            total_pkgs=$(jq '[.repositories | to_entries[] | .value.packages | to_entries[]] | length' config/package-cache.json)
            uptodate=$(jq '[.repositories | to_entries[] | .value.packages | to_entries[] | select(.value.version == .value.publishedVersion)] | length' config/package-cache.json)
            stale=$(jq '[.repositories | to_entries[] | .value.packages | to_entries[] | select(.value.version != .value.publishedVersion and .value.publishedVersion != null)] | length' config/package-cache.json)
            new=$(jq '[.repositories | to_entries[] | .value.packages | to_entries[] | select(.value.publishedVersion == null)] | length' config/package-cache.json)

            echo "- **Total packages**: $total_pkgs" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ **Up-to-date**: $uptodate" >> $GITHUB_STEP_SUMMARY
            echo "- ‚ö†Ô∏è **Needs publish**: $stale" >> $GITHUB_STEP_SUMMARY
            echo "- üÜï **Not published**: $new" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            cache_age=$(( ($(date +%s) - $(date -d "$(jq -r '.updated' config/package-cache.json)" +%s 2>/dev/null || echo 0)) / 3600 ))
            echo "üìÖ Cache age: $cache_age hours" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Package cache not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Collect statistics
        id: stats
        if: always()
        run: |
          # Repository counts
          total=$(jq '.repositories | length' config/repositories.json)
          active=$(jq '[.repositories[] | select(.status == "active")] | length' config/repositories.json)
          pending=$(jq '[.repositories[] | select(.status == "pending")] | length' config/repositories.json)
          disabled=$(jq '[.repositories[] | select(.status == "disabled")] | length' config/repositories.json)

          echo "total_repos=$total" >> $GITHUB_OUTPUT
          echo "active=$active" >> $GITHUB_OUTPUT
          echo "pending=$pending" >> $GITHUB_OUTPUT
          echo "disabled=$disabled" >> $GITHUB_OUTPUT

          # Package stats (if cache exists)
          if [ -f config/package-cache.json ]; then
            total_pkgs=$(jq '[.repositories | to_entries[] | .value.packages | to_entries[]] | length' config/package-cache.json)
            uptodate=$(jq '[.repositories | to_entries[] | .value.packages | to_entries[] | select(.value.version == .value.publishedVersion)] | length' config/package-cache.json)
            stale=$(jq '[.repositories | to_entries[] | .value.packages | to_entries[] | select(.value.version != .value.publishedVersion and .value.publishedVersion != null)] | length' config/package-cache.json)
            new=$(jq '[.repositories | to_entries[] | .value.packages | to_entries[] | select(.value.publishedVersion == null)] | length' config/package-cache.json)

            echo "total_pkgs=$total_pkgs" >> $GITHUB_OUTPUT
            echo "uptodate=$uptodate" >> $GITHUB_OUTPUT
            echo "stale=$stale" >> $GITHUB_OUTPUT
            echo "new=$new" >> $GITHUB_OUTPUT
            echo "cache_exists=true" >> $GITHUB_OUTPUT
          else
            echo "total_pkgs=0" >> $GITHUB_OUTPUT
            echo "uptodate=0" >> $GITHUB_OUTPUT
            echo "stale=0" >> $GITHUB_OUTPUT
            echo "new=0" >> $GITHUB_OUTPUT
            echo "cache_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger publishing workflows if needed
        if: steps.stats.outputs.cache_exists == 'true' && (steps.stats.outputs.new > 0 || steps.stats.outputs.stale > 0)
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "üöÄ Auto-triggering publishing workflows based on audit findings"
          echo ""

          # Trigger batch publish for unpublished packages
          if [ "${{ steps.stats.outputs.new }}" -gt 0 ]; then
            echo "üì¶ Found ${{ steps.stats.outputs.new }} unpublished packages"
            echo "   Triggering publish-unpublished.yml workflow..."
            if gh workflow run publish-unpublished.yml --repo The1Studio/UPMAutoPublisher; then
              echo "   ‚úÖ Batch publish workflow triggered successfully"
            else
              echo "   ‚ö†Ô∏è  Failed to trigger batch publish workflow"
            fi
            echo ""
          fi

          # Trigger stale publish for outdated packages
          if [ "${{ steps.stats.outputs.stale }}" -gt 0 ]; then
            echo "‚ö†Ô∏è  Found ${{ steps.stats.outputs.stale }} stale packages"
            echo "   Triggering trigger-stale-publishes.yml workflow..."
            if gh workflow run trigger-stale-publishes.yml --repo The1Studio/UPMAutoPublisher; then
              echo "   ‚úÖ Stale publish workflow triggered successfully"
            else
              echo "   ‚ö†Ô∏è  Failed to trigger stale publish workflow"
            fi
            echo ""
          fi

          echo "‚úÖ Workflow triggering completed"

      - name: Check for failures
        run: |
          # Audit script exits with 1 if mismatches found
          # This step will show failure status in workflow
          exit 0  # But don't fail the workflow

  notify-discord:
    runs-on: [self-hosted, arc, the1studio, org]
    needs: audit
    if: always()
    steps:
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_UPM }}
          DISCORD_THREAD_ID: "1437635908781342783"
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "‚ö†Ô∏è  DISCORD_WEBHOOK_UPM secret not set, skipping notification"
            exit 0
          fi

          # Determine status emoji and color
          status="${{ needs.audit.result }}"
          if [ "$status" == "success" ]; then
            status_emoji="‚úÖ"
            color=4764443  # Green
          elif [ "$status" == "failure" ]; then
            status_emoji="‚ùå"
            color=15158332  # Red
          else
            status_emoji="‚ö†Ô∏è"
            color=16776960  # Yellow
          fi

          workflow_url="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          registry_url="https://github.com/${{ github.repository }}/blob/master/config/repositories.json"
          timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          total_repos="${{ needs.audit.outputs.total_repos || '0' }}"
          active="${{ needs.audit.outputs.active || '0' }}"
          pending="${{ needs.audit.outputs.pending || '0' }}"
          disabled="${{ needs.audit.outputs.disabled || '0' }}"

          cache_exists="${{ needs.audit.outputs.cache_exists }}"
          total_pkgs="${{ needs.audit.outputs.total_pkgs || '0' }}"
          uptodate="${{ needs.audit.outputs.uptodate || '0' }}"
          stale="${{ needs.audit.outputs.stale || '0' }}"
          new="${{ needs.audit.outputs.new || '0' }}"

          # Build package status field value
          if [ "$cache_exists" == "true" ]; then
            pkg_status="```\nTotal:        $total_pkgs\nUp-to-date:   $uptodate\nStale:        $stale\nNot Published: $new\n```"
          else
            pkg_status="‚ö†Ô∏è **Cache not found**"
          fi

          jq -n \
            --arg status_emoji "$status_emoji" \
            --argjson color "$color" \
            --arg workflow_url "$workflow_url" \
            --arg registry_url "$registry_url" \
            --arg total_repos "$total_repos" \
            --arg active "$active" \
            --arg pending "$pending" \
            --arg disabled "$disabled" \
            --arg pkg_status "$pkg_status" \
            --arg timestamp "$timestamp" \
            '{
              "embeds": [{
                "author": {
                  "name": "UPM Auto Publisher",
                  "icon_url": "https://raw.githubusercontent.com/github/explore/80688e429a7d4ef2fca1e82350fe8e3517d3494d/topics/npm/npm.png"
                },
                "title": ($status_emoji + " Daily Repository Audit"),
                "description": ("üîç **Workflow:** Daily Audit\n‚è∞ **Schedule:** Daily at 9 AM UTC\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"),
                "color": $color,
                "fields": [
                  {
                    "name": "üìä Repository Status",
                    "value": ("```\nTotal:    " + $total_repos + "\nActive:   " + $active + "\nPending:  " + $pending + "\nDisabled: " + $disabled + "\n```"),
                    "inline": false
                  },
                  {
                    "name": "üì¶ Package Status",
                    "value": $pkg_status,
                    "inline": false
                  },
                  {
                    "name": "üîó Quick Links",
                    "value": ("[üìã Workflow Run](" + $workflow_url + ") ‚Ä¢ [üìù Registry](" + $registry_url + ")"),
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "THE 1 GAME STUDIO ‚Ä¢ Daily Job",
                  "icon_url": "https://raw.githubusercontent.com/The1Studio/UPMAutoPublisher/master/.github/assets/the1studio-logo.png"
                },
                "timestamp": $timestamp
              }]
            }' > discord_payload.json

          # Send to Discord (with thread_id as query parameter)
          curl -X POST "$DISCORD_WEBHOOK?thread_id=$DISCORD_THREAD_ID" \
            -H "Content-Type: application/json" \
            -d @discord_payload.json \
            --fail --silent --show-error || echo "‚ö†Ô∏è  Failed to send Discord notification"

          rm -f discord_payload.json
