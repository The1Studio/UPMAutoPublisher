name: Daily Package Version Check

on:
  schedule:
    # Run daily at 9:00 AM UTC (4:00 PM UTC+7)
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-all-repositories:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout UPMAutoPublisher
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Read repository registry
        id: read-repos
        run: |
          # Extract active repositories from config
          repos=$(jq -r '.repositories[] | select(.status == "active") | .url | sub("https://github.com/"; "")' config/repositories.json)
          echo "repos<<EOF" >> $GITHUB_OUTPUT
          echo "$repos" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check all repositories
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Initialize tracking files
          echo "" > changed_packages.txt
          echo "" > unchanged_packages.txt
          echo "" > errors.txt

          total_repos=0
          repos_with_changes=0
          repos_unchanged=0
          repos_errors=0

          # Read repositories from previous step
          repos="${{ steps.read-repos.outputs.repos }}"

          while IFS= read -r repo; do
            [ -z "$repo" ] && continue

            total_repos=$((total_repos + 1))
            echo "=== Checking: $repo ==="

            # Clone repository to temp directory
            tmpdir=$(mktemp -d)
            if ! git clone "https://github.com/$repo.git" "$tmpdir" 2>/dev/null; then
              echo "‚ùå Failed to clone $repo" | tee -a errors.txt
              repos_errors=$((repos_errors + 1))
              rm -rf "$tmpdir"
              continue
            fi

            cd "$tmpdir"

            # Find all package.json files
            package_files=$(find . -name "package.json" -not -path "*/node_modules/*" -not -path "*/.git/*")

            if [ -z "$package_files" ]; then
              echo "‚ö†Ô∏è  No package.json found in $repo" | tee -a unchanged_packages.txt
              repos_unchanged=$((repos_unchanged + 1))
              cd /
              rm -rf "$tmpdir"
              continue
            fi

            repo_has_changes=false

            # Check each package.json
            while IFS= read -r package_json; do
              [ -z "$package_json" ] && continue

              if [ ! -f "$package_json" ]; then
                continue
              fi

              package_name=$(jq -r '.name // "unknown"' "$package_json")
              package_version=$(jq -r '.version // "0.0.0"' "$package_json")

              # Get version from 24 hours ago
              git_date=$(date -u -d "24 hours ago" +"%Y-%m-%d %H:%M:%S")
              old_version=$(git log --since="$git_date" --format="" --name-only -- "$package_json" 2>/dev/null | head -1)

              if [ -n "$old_version" ]; then
                # Package changed in last 24 hours
                prev_version=$(git show "HEAD~1:$package_json" 2>/dev/null | jq -r '.version // "unknown"')

                if [ "$prev_version" != "$package_version" ]; then
                  echo "üì¶ **$repo** - $package_name: \`$prev_version\` ‚Üí \`$package_version\`" >> ../changed_packages.txt
                  repo_has_changes=true
                fi
              fi
            done <<< "$package_files"

            if [ "$repo_has_changes" = true ]; then
              repos_with_changes=$((repos_with_changes + 1))
            else
              echo "‚úì $repo - No changes" >> ../unchanged_packages.txt
              repos_unchanged=$((repos_unchanged + 1))
            fi

            cd /
            rm -rf "$tmpdir"
          done <<< "$repos"

          # Save summary
          echo "total_repos=$total_repos" >> $GITHUB_ENV
          echo "repos_with_changes=$repos_with_changes" >> $GITHUB_ENV
          echo "repos_unchanged=$repos_unchanged" >> $GITHUB_ENV
          echo "repos_errors=$repos_errors" >> $GITHUB_ENV

      - name: Send Discord notification
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_UPM }}
          DISCORD_THREAD_ID: "1437635908781342783"
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "‚ö†Ô∏è  DISCORD_WEBHOOK_UPM secret not set, skipping notification"
            exit 0
          fi

          # Read and format changes, unchanged, and errors
          changed_content=$(cat changed_packages.txt 2>/dev/null || echo "")
          unchanged_content=$(cat unchanged_packages.txt 2>/dev/null || echo "")
          errors_content=$(cat errors.txt 2>/dev/null || echo "")

          # Format package changes with beautiful structure
          if [ -n "$changed_content" ] && [ "$changed_content" != "" ]; then
            # Count changes
            change_count=$(echo "$changed_content" | grep -c "üì¶" || echo "0")

            # Format each change with emojis and structure
            package_changes="üîÑ **Found $change_count package update(s) in the last 24 hours:**\n\n"
            package_changes="${package_changes}$changed_content"
          else
            package_changes="‚úÖ **No package version changes detected**\n\nAll packages remain stable across all repositories."
          fi

          # Format unchanged repositories
          if [ -n "$unchanged_content" ] && [ "$unchanged_content" != "" ]; then
            unchanged_summary="üìã **Stable Repositories:**\n\`\`\`\n$unchanged_content\n\`\`\`"
          else
            unchanged_summary="No data"
          fi

          # Format errors with detailed structure
          if [ -n "$errors_content" ] && [ "$errors_content" != "" ]; then
            error_count=$(echo "$errors_content" | grep -c "‚ùå" || echo "0")
            errors_formatted="‚ö†Ô∏è **$error_count error(s) encountered:**\n\`\`\`\n$errors_content\n\`\`\`"
          else
            errors_formatted=""
          fi

          # Determine color and status based on results
          if [ "${{ env.repos_errors }}" -gt 0 ]; then
            color=15158332  # Red
            status_icon="‚ö†Ô∏è"
            status_text="Issues Detected"
          elif [ "${{ env.repos_with_changes }}" -gt 0 ]; then
            color=5763719   # Blue (matching publish notifications)
            status_icon="üì¶"
            status_text="Updates Detected"
          else
            color=5763719   # Blue
            status_icon="‚úÖ"
            status_text="All Stable"
          fi

          workflow_url="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # Construct beautiful Discord embed
          jq -n \
            --arg total "${{ env.total_repos }}" \
            --arg changed "${{ env.repos_with_changes }}" \
            --arg unchanged "${{ env.repos_unchanged }}" \
            --arg errors "${{ env.repos_errors }}" \
            --arg package_changes "$package_changes" \
            --arg unchanged_summary "$unchanged_summary" \
            --arg errors_formatted "$errors_formatted" \
            --arg workflow_url "$workflow_url" \
            --arg timestamp "$timestamp" \
            --arg color "$color" \
            --arg status_icon "$status_icon" \
            --arg status_text "$status_text" \
            '{
              "embeds": [{
                "author": {
                  "name": "UPM Auto Publisher - Daily Report",
                  "icon_url": "https://raw.githubusercontent.com/github/explore/80688e429a7d4ef2fca1e82350fe8e3517d3494d/topics/npm/npm.png"
                },
                "title": ($status_icon + " Daily Package Version Check"),
                "description": ("üìÖ **Monitoring Period:** Last 24 hours\nüîç **Status:** " + $status_text + "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"),
                "color": ($color | tonumber),
                "fields": [
                  {
                    "name": "üì¶ Version Changes Detected",
                    "value": $package_changes,
                    "inline": false
                  },
                  {
                    "name": "üìä Repository Statistics",
                    "value": ("üè¢ **Total Repositories:** " + $total + "\nüì¶ **With Changes:** " + $changed + "\n‚úÖ **Stable:** " + $unchanged + (if ($errors | tonumber) > 0 then ("\n‚ö†Ô∏è **Errors:** " + $errors) else "" end)),
                    "inline": false
                  }
                ] + (if $errors_formatted != "" then [{
                  "name": "‚ö†Ô∏è Errors Encountered",
                  "value": $errors_formatted,
                  "inline": false
                }] else [] end) + (if ($unchanged | tonumber) > 0 and $unchanged_summary != "No data" then [{
                  "name": "‚úÖ Stable Repositories",
                  "value": $unchanged_summary,
                  "inline": false
                }] else [] end) + [{
                  "name": "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ",
                  "value": "",
                  "inline": false
                }, {
                  "name": "üîó Links",
                  "value": ("üìã [View Workflow Run](" + $workflow_url + ")\nüì¶ [Registry](https://upm.the1studio.org)\nüìö [Documentation](https://github.com/The1Studio/UPMAutoPublisher)"),
                  "inline": false
                }],
                "thumbnail": {
                  "url": "https://raw.githubusercontent.com/github/explore/80688e429a7d4ef2fca1e82350fe8e3517d3494d/topics/unity/unity.png"
                },
                "timestamp": $timestamp,
                "footer": {
                  "text": "UPM Auto Publisher ‚Ä¢ The1Studio ‚Ä¢ Daily Check",
                  "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                }
              }]
            }' > discord_payload.json

          # Send to Discord (with thread_id as query parameter)
          curl -X POST "$DISCORD_WEBHOOK?thread_id=$DISCORD_THREAD_ID" \
            -H "Content-Type: application/json" \
            -d @discord_payload.json \
            --fail --silent --show-error || echo "‚ö†Ô∏è  Failed to send Discord notification"

          rm -f discord_payload.json
