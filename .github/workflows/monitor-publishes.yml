name: Monitor Package Publishes

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes

  workflow_dispatch:  # Manual trigger

permissions:
  contents: read

jobs:
  monitor:
    # Use self-hosted runners with GitHub-hosted fallback
    runs-on: ${{ vars.USE_SELF_HOSTED_RUNNERS != 'false' && fromJSON('["self-hosted", "arc", "the1studio", "org"]') || 'ubuntu-latest' }}
    timeout-minutes: 10
    name: Monitor publish workflows across repositories
    outputs:
      total_checked: ${{ steps.check_publishes.outputs.total_checked }}
      successful: ${{ steps.check_publishes.outputs.successful }}
      failed: ${{ steps.check_publishes.outputs.failed }}
      in_progress: ${{ steps.check_publishes.outputs.in_progress }}
      published_packages: ${{ steps.check_publishes.outputs.published_packages }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install dependencies
        run: |
          # Fix APT sources to use HTTPS instead of HTTP (port 80 blocked)
          sudo sed -i 's|http://archive.ubuntu.com|https://archive.ubuntu.com|g' /etc/apt/sources.list
          sudo sed -i 's|http://security.ubuntu.com|https://security.ubuntu.com|g' /etc/apt/sources.list

          # Disable PPA repositories
          sudo mv /etc/apt/sources.list.d /etc/apt/sources.list.d.bak 2>/dev/null || true
          sudo mkdir -p /etc/apt/sources.list.d

          sudo apt-get update -qq
          sudo apt-get install -y -qq jq

      - name: Check recent publish workflows
        id: check_publishes
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "üîç Monitoring publish workflows across all repositories..."
          echo ""

          # Track last check time (15 minutes ago)
          cutoff_time=$(date -u -d '15 minutes ago' --iso-8601=seconds)

          total_checked=0
          successful=0
          failed=0
          in_progress=0

          # Store published package details
          rm -f /tmp/published_packages.txt
          rm -f /tmp/failed_packages.txt

          # Process each active repository
          while IFS= read -r repo_json; do
            url=$(echo "$repo_json" | jq -r '.url')
            status=$(echo "$repo_json" | jq -r '.status')

            # Skip disabled repos
            if [ "$status" = "disabled" ]; then
              continue
            fi

            # Extract org/repo
            if [[ "$url" =~ ^https://github\.com/([a-zA-Z0-9_-]+)/([a-zA-Z0-9._-]+)$ ]]; then
              org="${BASH_REMATCH[1]}"
              repo="${BASH_REMATCH[2]}"
            else
              continue
            fi

            repo_full="$org/$repo"
            echo "Checking $repo_full..."

            # Check for recent publish-upm workflow runs
            runs=$(gh api "repos/$repo_full/actions/workflows/publish-upm.yml/runs?per_page=5" \
              --jq '.workflow_runs[] | select(.created_at >= "'"$cutoff_time"'") | "\(.id)|\(.status)|\(.conclusion)|\(.created_at)"' \
              2>/dev/null || echo "")

            if [ -z "$runs" ]; then
              continue
            fi

            # Process each recent run
            while IFS='|' read -r run_id run_status run_conclusion run_created; do
              total_checked=$((total_checked + 1))

              if [ "$run_status" = "completed" ]; then
                if [ "$run_conclusion" = "success" ]; then
                  successful=$((successful + 1))

                  # Try to extract published package info from logs
                  echo "$repo_full|$run_id|$run_created" >> /tmp/published_packages.txt

                elif [ "$run_conclusion" = "failure" ]; then
                  failed=$((failed + 1))
                  echo "$repo_full|$run_id|$run_created" >> /tmp/failed_packages.txt
                fi
              else
                in_progress=$((in_progress + 1))
              fi

            done <<< "$runs"

            sleep 0.5  # Rate limit protection

          done < <(jq -c '.repositories[]' config/repositories.json)

          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä Monitoring Summary"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Total workflows checked: $total_checked"
          echo "‚úÖ Successful: $successful"
          echo "‚ùå Failed: $failed"
          echo "üîÑ In Progress: $in_progress"
          echo ""

          # Output for Discord notification
          echo "total_checked=$total_checked" >> $GITHUB_OUTPUT
          echo "successful=$successful" >> $GITHUB_OUTPUT
          echo "failed=$failed" >> $GITHUB_OUTPUT
          echo "in_progress=$in_progress" >> $GITHUB_OUTPUT

          # Create summary of published packages
          if [ -f /tmp/published_packages.txt ]; then
            published_list=$(cat /tmp/published_packages.txt | head -10 | while IFS='|' read -r repo run_id created; do
              echo "‚úÖ $repo (Run: $run_id)"
            done)
            echo "published_packages<<EOF" >> $GITHUB_OUTPUT
            echo "$published_list" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "published_packages=" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        if: always()
        run: |
          total="${{ steps.check_publishes.outputs.total_checked }}"

          echo "# üîç Publish Monitor Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: $(date -u +%Y-%m-%d\ %H:%M:%S) UTC" >> $GITHUB_STEP_SUMMARY
          echo "**Monitoring Window**: Last 15 minutes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$total" = "0" ]; then
            echo "‚úÖ **No publish workflows detected in monitoring window**" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "## Activity Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total workflows**: $total" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ **Successful**: ${{ steps.check_publishes.outputs.successful }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ùå **Failed**: ${{ steps.check_publishes.outputs.failed }}" >> $GITHUB_STEP_SUMMARY
          echo "- üîÑ **In Progress**: ${{ steps.check_publishes.outputs.in_progress }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show published packages
          if [ -f /tmp/published_packages.txt ]; then
            echo "## ‚úÖ Successfully Published" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            while IFS='|' read -r repo run_id created; do
              echo "- **$repo** ([Run #$run_id](https://github.com/$repo/actions/runs/$run_id))" >> $GITHUB_STEP_SUMMARY
            done < /tmp/published_packages.txt
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Show failed packages
          if [ -f /tmp/failed_packages.txt ]; then
            echo "## ‚ùå Failed Publishes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            while IFS='|' read -r repo run_id created; do
              echo "- **$repo** ([Run #$run_id](https://github.com/$repo/actions/runs/$run_id))" >> $GITHUB_STEP_SUMMARY
            done < /tmp/failed_packages.txt
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

  notify-discord:
    # Use self-hosted runners with GitHub-hosted fallback
    runs-on: ${{ vars.USE_SELF_HOSTED_RUNNERS != 'false' && fromJSON('["self-hosted", "arc", "the1studio", "org"]') || 'ubuntu-latest' }}
    needs: monitor
    if: always() && needs.monitor.outputs.total_checked > 0
    steps:
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_UPM }}
          DISCORD_THREAD_ID: "1437635908781342783"
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "‚ö†Ô∏è  DISCORD_WEBHOOK_UPM secret not set, skipping notification"
            exit 0
          fi

          # Determine status emoji and color based on failures
          failed="${{ needs.monitor.outputs.failed || '0' }}"
          successful="${{ needs.monitor.outputs.successful || '0' }}"

          if [ "$failed" -gt 0 ]; then
            status_emoji="‚ùå"
            color=15158332  # Red
          elif [ "$successful" -gt 0 ]; then
            status_emoji="‚úÖ"
            color=4764443  # Green
          else
            status_emoji="üîÑ"
            color=16776960  # Yellow
          fi

          workflow_url="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          registry_url="https://github.com/${{ github.repository }}/blob/master/config/repositories.json"
          timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          monitoring_time=$(date -u +%H:%M)

          total="${{ needs.monitor.outputs.total_checked || '0' }}"
          in_progress="${{ needs.monitor.outputs.in_progress || '0' }}"

          jq -n \
            --arg status_emoji "$status_emoji" \
            --argjson color "$color" \
            --arg workflow_url "$workflow_url" \
            --arg registry_url "$registry_url" \
            --arg monitoring_time "$monitoring_time" \
            --arg total "$total" \
            --arg successful "$successful" \
            --arg failed "$failed" \
            --arg in_progress "$in_progress" \
            --arg timestamp "$timestamp" \
            '{
              "embeds": [{
                "author": {
                  "name": "UPM Auto Publisher",
                  "icon_url": "https://raw.githubusercontent.com/github/explore/80688e429a7d4ef2fca1e82350fe8e3517d3494d/topics/npm/npm.png"
                },
                "title": ($status_emoji + " Package Publish Activity"),
                "description": ("üìä **Workflow:** Publish Monitor\n‚è∞ **Window:** Last 15 minutes\nüïê **Time:** " + $monitoring_time + " UTC\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"),
                "color": $color,
                "fields": [
                  {
                    "name": "üìä Activity Summary",
                    "value": ("```\nTotal:       " + $total + "\nSuccessful:  " + $successful + "\nFailed:      " + $failed + "\nIn Progress: " + $in_progress + "\n```"),
                    "inline": false
                  },
                  {
                    "name": "üîó Quick Links",
                    "value": ("[üìã Workflow Run](" + $workflow_url + ") ‚Ä¢ [üìù Registry](" + $registry_url + ")"),
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "THE 1 GAME STUDIO ‚Ä¢ Monitoring",
                  "icon_url": "https://raw.githubusercontent.com/The1Studio/UPMAutoPublisher/master/.github/assets/the1studio-logo.png"
                },
                "timestamp": $timestamp
              }]
            }' > discord_payload.json

          # Send to Discord (with thread_id as query parameter)
          curl -X POST "$DISCORD_WEBHOOK?thread_id=$DISCORD_THREAD_ID" \
            -H "Content-Type: application/json" \
            -d @discord_payload.json \
            --fail --silent --show-error || echo "‚ö†Ô∏è  Failed to send Discord notification"

          rm -f discord_payload.json
