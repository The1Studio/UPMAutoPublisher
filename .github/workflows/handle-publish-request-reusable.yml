name: Reusable UPM Publish Handler

on:
  workflow_call:
    inputs:
      repository:
        description: 'Repository name (owner/repo)'
        required: true
        type: string
      commit_sha:
        description: 'Commit SHA to publish'
        required: true
        type: string
      commit_message:
        description: 'Commit message'
        required: true
        type: string
      commit_author:
        description: 'Commit author'
        required: true
        type: string
      branch:
        description: 'Branch name'
        required: true
        type: string
      package_path:
        description: 'Specific package path (optional, empty for auto-detect)'
        required: false
        type: string
        default: ''
    secrets:
      NPM_TOKEN:
        required: true
      DISCORD_WEBHOOK_UPM:
        required: false
      GEMINI_API_KEY:
        required: false
      GH_PAT:
        required: true

env:
  UPM_REGISTRY: ${{ vars.UPM_REGISTRY || 'https://upm.the1studio.org/' }}
  AUDIT_RETENTION_DAYS: 90

jobs:
  publish-packages:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout UPMAutoPublisher (for config)
        uses: actions/checkout@v4
        with:
          path: autopublisher

      - name: Validate repository is registered
        working-directory: autopublisher
        run: |
          echo "üîç Checking if ${{ inputs.repository }} is registered..."

          # Check if repository exists in config/repositories.json
          if ! jq -e --arg repo "${{ inputs.repository }}" \
            '.[] | select(.url | endswith($repo)) | select(.status == "active")' \
            config/repositories.json > /dev/null; then
            echo "‚ùå Repository ${{ inputs.repository }} is not registered or not active"
            echo "üìã Registered repositories:"
            jq -r '.[] | select(.status == "active") | .url' config/repositories.json
            exit 1
          fi

          echo "‚úÖ Repository is registered and active"

      - name: Validate inputs
        run: |
          echo "üì¶ Received publish request from: ${{ inputs.repository }}"
          echo "üìù Commit: ${{ inputs.commit_sha }}"
          echo "üë§ Author: ${{ inputs.commit_author }}"
          echo "üåø Branch: ${{ inputs.branch }}"

      - name: Clone target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.commit_sha }}
          path: target-repo
          token: ${{ secrets.GH_PAT }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: ${{ vars.UPM_REGISTRY || 'https://upm.the1studio.org/' }}

      - name: Configure npm authentication
        run: |
          echo "üîê Configuring npm authentication..."
          echo "//${{ vars.UPM_REGISTRY || 'upm.the1studio.org/' }}/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

      - name: Detect packages to publish
        id: detect
        working-directory: target-repo
        run: |
          echo "üîç Detecting packages to publish..."

          # If specific package requested
          if [ -n "${{ inputs.package_path }}" ]; then
            echo "üì¶ Specific package requested: ${{ inputs.package_path }}"
            if [ ! -f "${{ inputs.package_path }}/package.json" ]; then
              echo "‚ùå Package not found: ${{ inputs.package_path }}"
              exit 1
            fi
            echo "packages=${{ inputs.package_path }}/package.json" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Auto-detect changed packages
          changed_files=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep 'package\.json$' || echo "")

          if [ -z "$changed_files" ]; then
            echo "‚è≠Ô∏è  No package.json changes detected"
            echo "packages=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üì¶ Changed packages:"
          echo "$changed_files"
          echo "packages=$changed_files" >> $GITHUB_OUTPUT

      - name: Publish packages
        if: steps.detect.outputs.packages != ''
        working-directory: target-repo
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "üöÄ Publishing packages..."

          published_count=0
          skipped_count=0
          failed_count=0

          published_list=""
          skipped_list=""
          failed_list=""

          for package_json in ${{ steps.detect.outputs.packages }}; do
            package_dir=$(dirname "$package_json")
            package_name=$(jq -r '.name' "$package_json")
            new_version=$(jq -r '.version' "$package_json")

            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üì¶ Processing: $package_name@$new_version"
            echo "üìÅ Location: $package_dir"

            # Check if version exists
            if npm view "$package_name@$new_version" --registry "$UPM_REGISTRY" > /dev/null 2>&1; then
              echo "‚è≠Ô∏è  Version $new_version already exists, skipping..."
              skipped_count=$((skipped_count + 1))
              skipped_list="${skipped_list}‚Ä¢ $package_name@$new_version (already exists)\n"
              continue
            fi

            # Publish
            echo "üì§ Publishing to $UPM_REGISTRY..."
            cd "$package_dir"

            if npm publish --registry "$UPM_REGISTRY" 2>&1; then
              echo "‚úÖ Successfully published $package_name@$new_version"
              published_count=$((published_count + 1))
              published_list="${published_list}‚Ä¢ $package_name@$new_version\n"
            else
              echo "‚ùå Failed to publish $package_name@$new_version"
              failed_count=$((failed_count + 1))
              failed_list="${failed_list}‚Ä¢ $package_name@$new_version\n"
            fi

            cd - > /dev/null
          done

          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä Summary:"
          echo "‚úÖ Published: $published_count"
          echo "‚è≠Ô∏è  Skipped: $skipped_count"
          echo "‚ùå Failed: $failed_count"

          # Save to output
          echo "published=$published_count" >> $GITHUB_OUTPUT
          echo "skipped=$skipped_count" >> $GITHUB_OUTPUT
          echo "failed=$failed_count" >> $GITHUB_OUTPUT

          {
            echo "published_list<<EOF"
            echo -e "$published_list"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "skipped_list<<EOF"
            echo -e "$skipped_list"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "failed_list<<EOF"
            echo -e "$failed_list"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          # Exit with error if any failed
          if [ $failed_count -gt 0 ]; then
            exit 1
          fi

      - name: Send Discord notification
        if: always() && secrets.DISCORD_WEBHOOK_UPM != ''
        working-directory: autopublisher
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_UPM }}
          thread-id: ${{ vars.DISCORD_THREAD_PACKAGES }}
          workflow-name: "UPM Package Publish"
          workflow-emoji: "üì¶"
          status: ${{ job.status }}
          summary-fields: |
            [
              {
                "name": "üìä Results",
                "value": "‚úÖ Published: ${{ steps.publish.outputs.published }}\n‚è≠Ô∏è  Skipped: ${{ steps.publish.outputs.skipped }}\n‚ùå Failed: ${{ steps.publish.outputs.failed }}",
                "inline": false
              },
              {
                "name": "üì¶ Repository",
                "value": "${{ inputs.repository }}",
                "inline": true
              },
              {
                "name": "üåø Branch",
                "value": "${{ inputs.branch }}",
                "inline": true
              }
            ]
          details-fields: |
            [
              {
                "name": "‚úÖ Published Packages",
                "value": "${{ steps.publish.outputs.published_list || 'None' }}",
                "inline": false
              }
            ]
