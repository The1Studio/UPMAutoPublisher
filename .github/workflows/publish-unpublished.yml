name: Publish Unpublished Packages

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (don't actually publish)"
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  schedule:
    # Run every Sunday at 2:00 AM UTC (after weekly package cache rebuild)
    - cron: '0 2 * * 0'

jobs:
  publish-unpublished:
    name: Batch Publish Unpublished Packages
    # Use self-hosted runners with GitHub-hosted fallback
    runs-on: ${{ vars.USE_SELF_HOSTED_RUNNERS != 'false' && fromJSON('["self-hosted", "arc", "the1studio", "org"]') || 'ubuntu-latest' }}
    outputs:
      total_processed: ${{ steps.publish.outputs.total_processed }}
      successful: ${{ steps.publish.outputs.successful }}
      failed: ${{ steps.publish.outputs.failed }}
      skipped: ${{ steps.publish.outputs.skipped }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install dependencies
        run: |
          # Fix APT sources to use HTTPS instead of HTTP (port 80 blocked)
          sudo sed -i 's|http://archive.ubuntu.com|https://archive.ubuntu.com|g' /etc/apt/sources.list
          sudo sed -i 's|http://security.ubuntu.com|https://security.ubuntu.com|g' /etc/apt/sources.list

          # Disable PPA repositories
          sudo mv /etc/apt/sources.list.d /etc/apt/sources.list.d.bak 2>/dev/null || true
          sudo mkdir -p /etc/apt/sources.list.d

          sudo apt-get update -qq
          sudo apt-get install -y -qq jq

          # Install GitHub CLI
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: ${{ vars.UPM_REGISTRY || 'https://upm.the1studio.org/' }}

      - name: Configure NPM authentication
        run: |
          npm config set "//${{ vars.UPM_REGISTRY || 'upm.the1studio.org' }}/:_authToken" "${{ secrets.NPM_TOKEN }}"

      - name: Verify package cache exists
        run: |
          if [ ! -f "config/package-cache.json" ]; then
            echo "ERROR: package-cache.json not found!"
            echo "Run 'build-package-cache' workflow first"
            exit 1
          fi

      - name: Count unpublished packages
        id: count
        run: |
          echo "Starting count script..."
          count=0
          while IFS= read -r repo_entry; do
            while IFS= read -r pkg_entry; do
              pkg_data=$(echo "$pkg_entry" | jq -r '.value')
              published=$(echo "$pkg_data" | jq -r '.publishedVersion // "not-published"')
              if [ "$published" = "not-published" ] || [ "$published" = "null" ]; then
                count=$((count + 1))
              fi
            done < <(echo "$repo_entry" | jq -c '.value.packages | to_entries[]')
          done < <(jq -c '.repositories | to_entries[]' config/package-cache.json)
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "Found $count unpublished packages"
          if [ "$count" -eq 0 ]; then
            echo "No unpublished packages found"
            exit 0
          fi
          echo "Proceeding to publish $count packages"

      - name: Publish unpublished packages
        id: publish
        if: steps.count.outputs.count > 0
        env:
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
          UPM_REGISTRY: ${{ vars.UPM_REGISTRY || 'https://upm.the1studio.org/' }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "START: Starting batch publish process"
          echo "Dry run: $DRY_RUN"
          echo ""

          success=0
          failed=0
          skipped=0
          failed_packages=""

          # Process repositories and find unpublished packages
          while IFS= read -r repo_entry; do
            repo=$(echo "$repo_entry" | jq -r '.key')

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "PACKAGE: Repository: $repo"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Get unpublished packages for this repo
            unpublished_found=false
            temp_packages_file=$(mktemp)

            while IFS= read -r pkg_entry; do
              pkg_name=$(echo "$pkg_entry" | jq -r '.key')
              pkg_data=$(echo "$pkg_entry" | jq -r '.value')

              path=$(echo "$pkg_data" | jq -r '.path')
              version=$(echo "$pkg_data" | jq -r '.version')
              published=$(echo "$pkg_data" | jq -r '.publishedVersion // "not-published"')

              # Only process unpublished packages
              if [ "$published" = "not-published" ] || [ "$published" = "null" ]; then
                echo "$path|$pkg_name@$version" >> "$temp_packages_file"
                unpublished_found=true
              fi
            done < <(echo "$repo_entry" | jq -c '.value.packages | to_entries[]')

            if [ "$unpublished_found" = false ]; then
              echo "WARNING: No unpublished packages in this repo"
              rm -f "$temp_packages_file"
              continue
            fi

            packages=$(cat "$temp_packages_file")

            # Clone repository with retry logic
            temp_dir=$(mktemp -d)
            cd "$temp_dir" || exit 1

            echo "CLONE: Cloning repository..."
            clone_success=false
            max_retries=3
            for attempt in $(seq 1 $max_retries); do
              if [ $attempt -gt 1 ]; then
                wait_time=$((2 ** (attempt - 1)))  # Exponential backoff: 2, 4, 8 seconds
                echo "   RETRY: Attempt $attempt/$max_retries (waiting ${wait_time}s)..."
                sleep $wait_time
              fi

              if gh repo clone "$repo" repo 2>&1; then
                clone_success=true
                break
              fi

              if [ $attempt -lt $max_retries ]; then
                echo "   WARNING: Clone failed, will retry..."
              fi
            done

            if [ "$clone_success" = false ]; then
              echo "ERROR: Failed to clone repository after $max_retries attempts"
              # Count all packages in this repo as failed
              pkg_count=$(echo "$packages" | wc -l)
              failed=$((failed + pkg_count))
              cd - > /dev/null
              rm -rf "$temp_dir"
              continue
            fi

            cd repo || exit 1

            # Process each package
            while IFS='|' read -r path package_info; do
              echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              echo "   PACKAGE: $package_info"
              echo "   ðŸ“ Path: $path"

              if [ ! -d "$path" ]; then
                echo "   ERROR: Path not found in repository"
                failed=$((failed + 1))
                failed_packages="$failed_packages\n   - $package_info (path not found)"
                continue
              fi

              if [ ! -f "$path/package.json" ]; then
                echo "   ERROR: package.json not found"
                failed=$((failed + 1))
                failed_packages="$failed_packages\n   - $package_info (no package.json)"
                continue
              fi

              cd "$path" || { echo "   ERROR: Cannot cd to path"; failed=$((failed + 1)); continue; }

              # Verify package.json is valid
              if ! jq empty package.json 2>/dev/null; then
                echo "   ERROR: Invalid package.json"
                failed=$((failed + 1))
                failed_packages="$failed_packages\n   - $package_info (invalid JSON)"
                cd - > /dev/null
                continue
              fi

              # Extract package name and version
              pkg_name=$(jq -r '.name' package.json)
              pkg_version=$(jq -r '.version' package.json)

              echo "   INFO: Name: $pkg_name"
              echo "   VERSION: Version: $pkg_version"

              # Check if already published (double-check)
              if npm view "$pkg_name@$pkg_version" --registry "$UPM_REGISTRY" > /dev/null 2>&1; then
                echo "   WARNING: Already published, skipping"
                skipped=$((skipped + 1))
                cd - > /dev/null
                continue
              fi

              # Publish package
              if [ "$DRY_RUN" = "true" ]; then
                echo "   DRY-RUN: DRY RUN: Would publish $pkg_name@$pkg_version"
                if npm publish --dry-run --registry "$UPM_REGISTRY" 2>&1; then
                  echo "   SUCCESS: Dry run successful"
                  success=$((success + 1))
                else
                  echo "   ERROR: Dry run failed"
                  failed=$((failed + 1))
                  failed_packages="$failed_packages\n   - $package_info (dry run failed)"
                fi
              else
                echo "   PUBLISH: Publishing to $UPM_REGISTRY..."
                if npm publish --registry "$UPM_REGISTRY" 2>&1; then
                  echo "   SUCCESS: Published successfully"
                  success=$((success + 1))
                else
                  echo "   ERROR: Failed to publish"
                  failed=$((failed + 1))
                  failed_packages="$failed_packages\n   - $package_info"
                fi
              fi

              cd - > /dev/null
              echo ""
            done <<< "$packages"

            # Cleanup repo and temp file
            rm -f "$temp_packages_file"
            cd - > /dev/null
            cd - > /dev/null
            rm -rf "$temp_dir"

            echo ""
          done < <(jq -c '.repositories | to_entries[]' config/package-cache.json)

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "SUMMARY: Batch Publish Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "SUCCESS: Published: $success"
          echo "WARNING: Skipped (already published): $skipped"
          echo "ERROR: Failed: $failed"
          echo "TOTAL: Total processed: $((success + skipped + failed))"

          if [ $failed -gt 0 ]; then
            echo ""
            echo "ERROR: Failed packages:"
            echo -e "$failed_packages"
            exit 1
          fi

          echo ""
          echo "SUCCESS: Batch publish completed successfully!"

          # Set outputs for Discord notification
          echo "total_processed=$((success + skipped + failed))" >> $GITHUB_OUTPUT
          echo "successful=$success" >> $GITHUB_OUTPUT
          echo "failed=$failed" >> $GITHUB_OUTPUT
          echo "skipped=$skipped" >> $GITHUB_OUTPUT

      - name: Rebuild package cache
        if: success() && (inputs.dry_run == 'false' || github.event_name == 'schedule')
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "REBUILD: Rebuilding package cache after publishing..."
          if [ -x "./scripts/build-package-cache.sh" ]; then
            ./scripts/build-package-cache.sh
          else
            echo "WARNING: build-package-cache.sh not found or not executable"
          fi

      - name: Commit updated cache
        if: success() && (inputs.dry_run == 'false' || github.event_name == 'schedule')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet config/package-cache.json; then
            echo "INFO: No changes to package cache"
          else
            git add config/package-cache.json
            git commit -m "$(cat <<'EOF'
          Update package cache after batch publish

          Published packages are now marked as up-to-date in the cache.

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          EOF
          )"
            git push
            echo "SUCCESS: Package cache updated"
          fi

  notify-discord:
    # Use self-hosted runners with GitHub-hosted fallback
    runs-on: ${{ vars.USE_SELF_HOSTED_RUNNERS != 'false' && fromJSON('["self-hosted", "arc", "the1studio", "org"]') || 'ubuntu-latest' }}
    needs: publish-unpublished
    if: always()
    steps:
      - name: Send Discord notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ needs.publish-unpublished.result }}
          title: "PACKAGE: Batch Publish Unpublished Packages"
          description: |
            **Workflow:** Publish Unpublished
            **Trigger:** ${{ github.event_name == 'schedule' && 'Scheduled (Weekly)' || 'Manual' }}
            **Dry Run:** ${{ inputs.dry_run || 'false' }}

            **SUMMARY: Results:**
            â€¢ Total Processed: `${{ needs.publish-unpublished.outputs.total_processed || '0' }}`
            â€¢ SUCCESS: Published: `${{ needs.publish-unpublished.outputs.successful || '0' }}`
            â€¢ WARNING: Skipped: `${{ needs.publish-unpublished.outputs.skipped || '0' }}`
            â€¢ ERROR: Failed: `${{ needs.publish-unpublished.outputs.failed || '0' }}`

            **ðŸ”— Links:**
            â€¢ [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            â€¢ [Package Cache](${{ github.server_url }}/${{ github.repository }}/blob/master/config/package-cache.json)
          color: ${{ needs.publish-unpublished.result == 'success' && '0x48C21B' || needs.publish-unpublished.result == 'failure' && '0xFF0000' || '0xFFCC00' }}
          username: "THE 1 GAME STUDIO"
          avatar_url: "https://raw.githubusercontent.com/The1Studio/UPMAutoPublisher/master/.github/assets/the1studio-logo.png"
